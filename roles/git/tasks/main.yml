---
# tasks file for git
- name: install git
  package:
    name: "{{ git_packages }}"
    state: present
  register: git_install_git
  until: git_install_git is succeeded
  retries: 3

- name: create repository_destination
  file:
    path: "{{ git_repository_destination }}"
    state: directory
  when: git_repository_destination is defined

# openssh_keypair has a bug bugs, if key already exists and needs to be deleted firstã€‚ Modify the source code
- name: generate pubilc key
  openssh_keypair:
    path: ~/.ssh/id_rsa
    type: rsa
    force: False
    state: present
  register: ssh_keygen

# tasks file for git
- name: debug gogs_deploy_key.py
  gogs_deploy_key:
    domain: "{{ git_domain }}"
    api_username: "{{ git_api_username }}"
    api_password: "{{ git_api_password }}"
    project: "{{ git_project }}"
    title: "{{ title }}"
    key: "{{ ssh_keygen.public_key }}"
    state: "present"
  # Delegate local execution gogs_deploy_key, remote python environment is not required
  # hosts configuration ansible_python_interpreter
  delegate_to: 127.0.0.1

# git clone data
